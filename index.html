<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1f2937">
  <meta name="description" content="Sistema de control de gastos para casas en arriendo">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <title>Control de Gastos - Casas en Arriendo</title>
  
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            primary: {
              DEFAULT: '#4f46e5',
              hover: '#4338ca',
            },
            secondary: '#6b7280',
            success: '#10b981',
            danger: '#ef4444',
            warning: '#f59e0b',
          },
          boxShadow: {
            'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
            'card-hover': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
          },
        },
      },
    }
  </script>
  <style>
    /* Custom styles */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .status-pending {
      background-color: #fef3c7;
      color: #92400e;
    }
    
    .status-paid {
      background-color: #d1fae5;
      color: #065f46;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 0.75rem;
      box-shadow: var(--card-shadow);
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    th {
      background-color: #f9fafb;
      color: #6b7280;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      text-align: left;
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
      background: white;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background-color: #f9fafb;
    }

    .section-title {
      color: #111827;
      font-weight: 700;
      font-size: 1.25rem;
      margin-bottom: 1.5rem;
      position: relative;
      padding-bottom: 0.5rem;
    }

    .section-title:after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      width: 3rem;
      height: 3px;
      background: var(--primary);
      border-radius: 3px;
    }

    .summary-card {
      background: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
    }

    .summary-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--card-hover);
    }

    .summary-title {
      color: #6b7280;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .summary-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col font-sans">
  <header class="bg-gray-800 text-white p-4 relative">
    <h1 class="text-2xl font-bold">Control de Gastos - Casas en Arriendo</h1>
    <button id="installButton" class="hidden absolute right-4 top-1/2 transform -translate-y-1/2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
      Instalar App
    </button>
  </header>
  <main class="container mx-auto p-4 flex-grow">
    <section class="mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Ingresar Costos Fijos</h2>
        <div id="currentMonthDisplay" class="text-lg font-medium text-gray-700"></div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h3 class="font-medium mb-2">Agua</h3>
        <div id="waterFixedItems" class="space-y-2 mb-4"></div>
        <div class="flex space-x-2">
          <input type="text" id="waterItemName" placeholder="Nombre del √≠tem" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
          <input type="number" id="waterItemAmount" step="0.01" min="0" placeholder="Monto ($)" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
          <button id="addWaterItemButton" class="mt-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">A√±adir</button>
        </div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="font-medium mb-2">Electricidad</h3>
        <div id="electricityFixedItems" class="space-y-2 mb-4"></div>
        <div class="flex space-x-2">
          <input type="text" id="electricityItemName" placeholder="Nombre del √≠tem" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
          <input type="number" id="electricityItemAmount" step="0.01" min="0" placeholder="Monto ($)" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
          <button id="addElectricityItemButton" class="mt-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">A√±adir</button>
        </div>
        <p id="fixedCostsStatus" class="mt-2 text-sm text-gray-600"></p>
      </div>
    </section>
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-4">Registrar Nuevos Consumos</h2>
      <div class="bg-white p-6 rounded-lg shadow space-y-6">
        <div class="border-b pb-4 mb-4">
          <h3 class="text-lg font-medium mb-3">Agua</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h4 class="font-medium mb-2">Casa 1</h4>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Lectura Anterior (m¬≥)</label>
                <input type="number" id="prevWater1" step="0.01" min="0" class="mt-1 mb-2 block w-full border-gray-300 rounded-md shadow-sm">
                <label class="block text-sm font-medium text-gray-700">Lectura Actual (m¬≥)</label>
                <input type="number" id="water1" step="0.01" min="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
              </div>
            </div>
            <div>
              <h4 class="font-medium mb-2">Casa 2</h4>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Lectura Anterior (m¬≥)</label>
                <input type="number" id="prevWater2" step="0.01" min="0" class="mt-1 mb-2 block w-full border-gray-300 rounded-md shadow-sm">
                <label class="block text-sm font-medium text-gray-700">Lectura Actual (m¬≥)</label>
                <input type="number" id="water2" step="0.01" min="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
              </div>
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700">Total Factura Agua ($)</label>
            <input type="number" id="totalWaterBill" step="0.01" min="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
          </div>
        </div>
        <div>
          <h3 class="text-lg font-medium mb-3">Electricidad</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h4 class="font-medium mb-2">Casa 1</h4>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Lectura Anterior (kWh)</label>
                <input type="number" id="prevElectricity1" step="0.01" min="0" class="mt-1 mb-2 block w-full border-gray-300 rounded-md shadow-sm">
                <label class="block text-sm font-medium text-gray-700">Lectura Actual (kWh)</label>
                <input type="number" id="electricity1" step="0.01" min="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
              </div>
            </div>
            <div>
              <h4 class="font-medium mb-2">Casa 2</h4>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Lectura Anterior (kWh)</label>
                <input type="number" id="prevElectricity2" step="0.01" min="0" class="mt-1 mb-2 block w-full border-gray-300 rounded-md shadow-sm">
                <label class="block text-sm font-medium text-gray-700">Lectura Actual (kWh)</label>
                <input type="number" id="electricity2" step="0.01" min="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
              </div>
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700">Total Factura Electricidad ($)</label>
            <input type="number" id="totalElectricityBill" step="0.01" min="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
          </div>
        </div>
        <button id="saveButton" class="mt-6 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 w-full">Guardar Registro</button>
      </div>
    </section>
    <section class="mt-10">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Historial de Gastos</h2>
        </div>
        <div class="flex flex-wrap gap-3 w-full md:w-auto">
          <button id="exportPdf" class="btn-primary flex items-center justify-center w-full md:w-auto px-4 py-2">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Exportar PDF
          </button>
          <div class="relative w-full md:w-64">
            <input type="text" id="searchExpenses" placeholder="Buscar en historial..." class="input-field w-full pl-10 pr-4 py-2">
            <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="summary-card">
          <div class="summary-title">Gasto Total</div>
          <div id="totalExpense" class="summary-value">$0</div>
          <div class="text-xs text-green-600 mt-1">+2.5% vs mes anterior</div>
        </div>
        <div class="summary-card">
          <div class="summary-title">Promedio Mensual</div>
          <div id="avgExpense" class="summary-value">$0</div>
          <div class="text-xs text-blue-600 mt-1">√öltimos 6 meses</div>
        </div>
        <div class="summary-card">
          <div class="summary-title">Gastos este Mes</div>
          <div id="currentMonthExpense" class="summary-value">$0</div>
          <div class="text-xs text-gray-500 mt-1">Actualizado hace 5 min</div>
        </div>
      </div>
      
      <div class="card overflow-hidden">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Detalle</th>
                <th class="text-right">Casa 1</th>
                <th class="text-right">Casa 2</th>
                <th class="text-right">Total</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="expensesList" class="divide-y divide-gray-100">
              <!-- Expenses will be loaded here -->
            </tbody>
          </table>
        </div>
        <div class="px-6 py-3 bg-gray-50 border-t border-gray-100 flex items-center justify-between">
          <div class="text-sm text-gray-500">
            Mostrando <span id="showingCount">1-10</span> de <span id="totalCount">0</span> registros
          </div>
          <div class="flex space-x-2">
            <button class="px-3 py-1 border rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
              Anterior
            </button>
            <button class="px-3 py-1 border rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
              Siguiente
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>
  <script>
    let db;
    let isUpdating = false;

    // Initialize the database
    async function initDatabase() {
      try {
        if (window.db) {
          try {
            await window.db.close();
            console.log('Previous database connection closed');
          } catch (err) {
            console.log('No previous database to close or error:', err);
          }
        }
        
        db = new Dexie("RentalExpensesDB");
        
        // Define database schema
        db.version(1).stores({
          expenses: '++id, date',
          fixedCosts: '++id, date',
          lastReadings: 'id'
        });
        
        // Initialize with default data if needed
        db.on('populate', async () => {
          try {
            await db.lastReadings.put({
              id: 1,
              water1: 0,
              water2: 0,
              electricity1: 0,
              electricity2: 0
            });
            
            // Initialize empty fixed costs for current month
            const yearMonth = new Date().toISOString().slice(0, 7);
            await db.fixedCosts.add({
              date: yearMonth,
              waterItems: [],
              electricityItems: []
            });
          } catch (err) {
            console.error('Error populating database:', err);
          }
        });
        
        await db.open();
        console.log('Database opened successfully');
        
        // Ensure we have a fixed costs record for current month
        await getOrCreateMonthlyFixedCosts();
        
        return true;
      } catch (error) {
        console.error('Failed to initialize database:', error);
        return false;
      }
    }
    
    // Get or create monthly fixed costs
    async function getOrCreateMonthlyFixedCosts() {
      const yearMonth = new Date().toISOString().slice(0, 7);
      
      try {
        let fixedCosts = await db.fixedCosts.where('date').equals(yearMonth).first();
        
        if (!fixedCosts) {
          const lastFixedCosts = await db.fixedCosts.orderBy('date').last() || {
            waterItems: [],
            electricityItems: []
          };
          
          const newId = await db.fixedCosts.add({
            date: yearMonth,
            waterItems: lastFixedCosts.waterItems || [],
            electricityItems: lastFixedCosts.electricityItems || []
          });
          
          fixedCosts = await db.fixedCosts.get(newId);
        }
        
        return fixedCosts;
      } catch (error) {
        console.error('Error in getOrCreateMonthlyFixedCosts:', error);
        return { date: yearMonth, waterItems: [], electricityItems: [] };
      }
    }

    async function loadFixedCosts() {
      const fixedCosts = await getOrCreateMonthlyFixedCosts();
      const waterItemsDiv = document.getElementById('waterFixedItems');
      const electricityItemsDiv = document.getElementById('electricityFixedItems');
      const status = document.getElementById('fixedCostsStatus');

      waterItemsDiv.innerHTML = '';
      electricityItemsDiv.innerHTML = '';
      
      const currentMonth = new Date().toLocaleString('es-CL', { month: 'long', year: 'numeric' });
      document.getElementById('currentMonthDisplay').textContent = `Costos Fijos - ${currentMonth.charAt(0).toUpperCase() + currentMonth.slice(1)}`;

      const loadItems = (items, containerId, type) => {
        if (items && items.length) {
          items.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex justify-between items-center mb-2 p-2 bg-gray-50 rounded';
            // Create elements manually to avoid HTML injection issues
            const nameSpan = document.createElement('span');
            nameSpan.textContent = `${item.name}: $${item.amount.toFixed(2)}`;
            
            const editBtn = document.createElement('button');
            editBtn.className = 'text-blue-600 hover:text-blue-800 text-sm';
            editBtn.textContent = 'Editar';
            editBtn.onclick = () => editFixedCostItem(type, index, item.name, item.amount);
            
            const separator = document.createElement('span');
            separator.className = 'text-gray-300';
            separator.textContent = ' | ';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'text-red-600 hover:text-red-800 text-sm';
            deleteBtn.textContent = 'Eliminar';
            deleteBtn.onclick = () => deleteFixedCost(type, index);
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'space-x-2';
            buttonContainer.appendChild(editBtn);
            buttonContainer.appendChild(separator);
            buttonContainer.appendChild(deleteBtn);
            
            itemDiv.appendChild(nameSpan);
            itemDiv.appendChild(buttonContainer);
            document.getElementById(containerId).appendChild(itemDiv);
          });
        }
      };

      loadItems(fixedCosts.waterItems, 'waterFixedItems', 'water');
      loadItems(fixedCosts.electricityItems, 'electricityFixedItems', 'electricity');

      const hasItems = (fixedCosts.waterItems.length > 0 || fixedCosts.electricityItems.length > 0);
      status.textContent = hasItems ? '√çtems de costos fijos cargados. A√±ada o elimine seg√∫n sea necesario.' : 'No hay √≠tems de costos fijos configurados. Ingrese y guarde los valores.';
    }

    async function deleteFixedCost(type, index) {
      const yearMonth = new Date().toISOString().slice(0, 7);
      const fixedCosts = await db.fixedCosts.where('date').equals(yearMonth).first();
      if (!fixedCosts) return;
      
      if (type === 'water') {
        fixedCosts.waterItems.splice(index, 1);
      } else if (type === 'electricity') {
        fixedCosts.electricityItems.splice(index, 1);
      }
      await db.fixedCosts.update(fixedCosts.id, { [`${type}Items`]: fixedCosts[`${type}Items`] });
      await loadFixedCosts();
    }
    window.deleteFixedCost = deleteFixedCost;

    async function editFixedCostItem(type, index, currentName, currentAmount) {
      const newName = prompt('Editar nombre del √≠tem:', currentName);
      if (newName === null) return; // User cancelled
      
      const newAmount = parseFloat(prompt('Editar monto:', currentAmount));
      if (isNaN(newAmount) || newAmount <= 0) {
        alert('Por favor ingrese un monto v√°lido mayor a 0');
        return;
      }

      try {
        const fixedCosts = await getOrCreateMonthlyFixedCosts();
        if (!fixedCosts) return;
        
        const items = fixedCosts[`${type}Items`];
        if (!items || !items[index]) return;

        // Update the item
        items[index] = { ...items[index], name: newName, amount: newAmount };
        
        // Save to database
        await db.fixedCosts.update(fixedCosts.id, { 
          [`${type}Items`]: items 
        });
        
        // Refresh the display
        await loadFixedCosts();
        
        // Show success message
        const statusElement = document.getElementById('fixedCostsStatus');
        statusElement.textContent = '√çtem actualizado exitosamente.';
        statusElement.className = 'text-green-600 mt-2 text-sm';
        
      } catch (error) {
        console.error('Error updating fixed cost item:', error);
        alert('Error al actualizar el √≠tem: ' + (error.message || 'Error desconocido'));
      }
    }
    window.editFixedCostItem = editFixedCostItem;

    async function addFixedCostItem(type) {
      const nameInput = document.getElementById(`${type}ItemName`);
      const amountInput = document.getElementById(`${type}ItemAmount`);
      const addButton = document.getElementById(`add${type.charAt(0).toUpperCase() + type.slice(1)}ItemButton`);
      const statusElement = document.getElementById('fixedCostsStatus');
      
      // Check if required elements exist
      if (!nameInput || !amountInput || !addButton || !statusElement) {
        console.error('Required elements not found');
        return;
      }
      
      const name = nameInput.value.trim();
      const amount = parseFloat(amountInput.value);
      const typeName = type === 'water' ? 'agua' : 'electricidad';
      let statusMessage = '';

      // Validate inputs
      if (!name) {
        statusElement.textContent = `Por favor ingrese un nombre para el √≠tem de ${typeName}.`;
        statusElement.className = 'text-red-600 mt-2 text-sm';
        nameInput.focus();
        return;
      }
      
      if (isNaN(amount) || amount <= 0) {
        statusElement.textContent = `Por favor ingrese un monto v√°lido (mayor a 0) para el √≠tem de ${typeName}.`;
        statusElement.className = 'text-red-600 mt-2 text-sm';
        amountInput.focus();
        return;
      }

      try {
        // Show loading state
        const originalButtonText = addButton.innerHTML;
        addButton.disabled = true;
        addButton.innerHTML = '<span class="inline-block animate-spin mr-2">‚Üª</span>Guardando...';
        statusElement.textContent = 'Guardando...';
        statusElement.className = 'text-blue-600 mt-2 text-sm';

        // Get or create fixed costs for current month
        const fixedCosts = await getOrCreateMonthlyFixedCosts();
        if (!fixedCosts) {
          throw new Error('No se pudo obtener o crear el registro de costos fijos');
        }
        
        // Ensure items array exists
        if (!Array.isArray(fixedCosts[`${type}Items`])) {
          fixedCosts[`${type}Items`] = [];
        }
        
        // Check for existing item with same name (case insensitive)
        const items = fixedCosts[`${type}Items`];
        const existingItemIndex = items.findIndex(item => 
          item.name && item.name.toLowerCase() === name.toLowerCase()
        );
        
        // Update or add item
        if (existingItemIndex >= 0) {
          items[existingItemIndex].amount = amount;
          statusMessage = `√çtem de ${typeName} actualizado exitosamente.`;
        } else {
          items.push({ name, amount, isFixed: true });
          statusMessage = `√çtem de ${typeName} agregado exitosamente.`;
        }
        
        // Save to database
        const updateData = { 
          [`${type}Items`]: items,
          date: fixedCosts.date || new Date().toISOString().slice(0, 7) // Ensure date is set
        };
        
        await db.fixedCosts.update(fixedCosts.id, updateData);
        
        // Clear inputs and update UI
        nameInput.value = '';
        amountInput.value = '';
        nameInput.focus();
        
        // Update UI
        await loadFixedCosts();
        
        // Show success message
        statusElement.textContent = statusMessage;
        statusElement.className = 'text-green-600 mt-2 text-sm';
        
      } catch (error) {
        console.error('Error adding fixed cost item:', error);
        const errorMessage = error.message || 'Error desconocido';
        console.error('Error details:', { type, name, amount, error: errorMessage });
        statusElement.textContent = `Error al guardar el √≠tem: ${errorMessage}`;
        statusElement.className = 'text-red-600 mt-2 text-sm';
      } finally {
        // Restore button state
        if (addButton) {
          addButton.disabled = false;
          addButton.innerHTML = 'A√±adir';
        }
      }
    }

    // Add event listeners for Enter key in input fields
    function setupInputListeners(type) {
      const nameInput = document.getElementById(`${type}ItemName`);
      const amountInput = document.getElementById(`${type}ItemAmount`);
      const addButton = document.getElementById(`add${type.charAt(0).toUpperCase() + type.slice(1)}ItemButton`);
      
      if (nameInput && amountInput) {
        // Add click event to the add button
        if (addButton) {
          addButton.addEventListener('click', () => addFixedCostItem(type));
        }
        
        // Handle Enter key in name input
        nameInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            amountInput.focus();
          }
        });
        
        // Handle Enter key in amount input
        amountInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            addFixedCostItem(type);
          }
        });
      }
    }

    function formatDate(date) {
      return new Date(date).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
    }

    async function updateSummaryCards(expenses) {
      if (expenses.length === 0) {
        return; // Keep the default empty state
      }

      const currentMonth = new Date().getMonth();
      const currentYear = new Date().getFullYear();
      
      // Calculate totals
      const totalExpense = expenses.reduce((sum, exp) => {
        const water = parseFloat(exp.totalWaterBill || 0);
        const electricity = parseFloat(exp.totalElectricityBill || 0);
        return sum + water + electricity;
      }, 0);
      
      // Calculate current month expenses
      const currentMonthExpenses = expenses.filter(exp => {
        const expDate = new Date(exp.date);
        return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
      });
      
      const currentMonthTotal = currentMonthExpenses.reduce((sum, exp) => {
        const water = parseFloat(exp.totalWaterBill || 0);
        const electricity = parseFloat(exp.totalElectricityBill || 0);
        return sum + water + electricity;
      }, 0);
      
      // Calculate average of last 6 months
      const sixMonthsAgo = new Date();
      sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
      
      const lastSixMonthsExpenses = expenses.filter(exp => {
        const expDate = new Date(exp.date);
        return expDate >= sixMonthsAgo;
      });
      
      const monthlyAverages = {};
      lastSixMonthsExpenses.forEach(exp => {
        const expDate = new Date(exp.date);
        const monthYear = `${expDate.getFullYear()}-${expDate.getMonth()}`;
        const water = parseFloat(exp.totalWaterBill || 0);
        const electricity = parseFloat(exp.totalElectricityBill || 0);
        
        if (!monthlyAverages[monthYear]) {
          monthlyAverages[monthYear] = 0;
        }
        monthlyAverages[monthYear] += water + electricity;
      });
      
      const avgExpense = Object.values(monthlyAverages).reduce((sum, val) => sum + val, 0) / 
                        Math.max(Object.keys(monthlyAverages).length, 1);
      
      // Update the summary cards
      const totalExpenseEl = document.getElementById('totalExpense');
      const avgExpenseEl = document.getElementById('avgExpense');
      const currentMonthExpenseEl = document.getElementById('currentMonthExpense');
      
      if (totalExpenseEl) totalExpenseEl.textContent = formatCurrency(totalExpense);
      if (avgExpenseEl) avgExpenseEl.textContent = formatCurrency(avgExpense);
      if (currentMonthExpenseEl) currentMonthExpenseEl.textContent = formatCurrency(currentMonthTotal);
    }

    // Charts have been removed as requested

    // Nombres de los arrendatarios (pueden ser personalizados)
    const tenantNames = {
      1: 'Casa 1 - Arrendatario 1',  // Reemplazar con el nombre real del arrendatario 1
      2: 'Casa 2 - Arrendatario 2'   // Reemplazar con el nombre real del arrendatario 2
    };

    // Funci√≥n para generar un PDF para una casa espec√≠fica
    async function generateHousePDF(houseNumber, latestExpense) {
      const { jsPDF } = window.jspdf;
      const formattedDate = new Date(latestExpense.date).toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' });
      const waterTotalBill = formatCurrency(latestExpense.totalWaterBill);
      const electricityTotalBill = formatCurrency(latestExpense.totalElectricityBill);

      const doc = new jsPDF();
      let yPos = 20;

        const generateReport = (doc, houseNumber, houseTotal, waterConsumption, electricityConsumption, waterDistribution, electricityDistribution, waterFixedItems, electricityFixedItems, isFirstPage = true) => {
          if (!isFirstPage) {
            doc.addPage();
            yPos = 20;
          }
          
          // T√≠tulo del informe con el nombre del arrendatario
          doc.setFontSize(16);
          doc.setTextColor(0, 0, 0);
          doc.setFont(undefined, 'bold');
          doc.text('INFORME DE GASTOS', 14, yPos);
          yPos += 8;
          
          // Nombre del arrendatario
          doc.setFontSize(14);
          doc.setTextColor(59, 130, 246);
          doc.text(tenantNames[houseNumber], 14, yPos);
          yPos += 10;
          // Fecha y detalles del reporte
          doc.setFontSize(10);
          doc.setTextColor(100);
          doc.setFont(undefined, 'normal');
          doc.text(`Fecha del Reporte: ${formattedDate}`, 14, yPos);
          yPos += 5;
          
          // L√≠nea divisoria
          doc.setDrawColor(200, 200, 200);
          doc.line(14, yPos, 200, yPos);
          yPos += 10;
          // Totales de facturas
          doc.setFontSize(10);
          doc.text(`Total factura Agua: ${waterTotalBill}`, 14, yPos);
          yPos += 5;
          doc.text(`Total factura Electricidad: ${electricityTotalBill}`, 14, yPos);
          yPos += 10;

          // Secci√≥n de desglose
          doc.setFontSize(12);
          doc.setTextColor(0, 0, 0);
          doc.setFont(undefined, 'bold');
          doc.text('DETALLE DE CONSUMOS Y COSTOS', 14, yPos);
          yPos += 8;
          
          // L√≠nea divisoria m√°s delgada
          doc.setDrawColor(220, 220, 220);
          doc.line(14, yPos, 200, yPos);
          yPos += 10;

          // Water details
          const waterTotal = houseNumber === 1 ? waterDistribution.house1 : waterDistribution.house2;
          const currentWater = houseNumber === 1 ? latestExpense.water1 : latestExpense.water2;
          const prevWater = houseNumber === 1 ? latestExpense.prevWater1 : latestExpense.prevWater2;
          const actualWaterConsumption = Math.max(0, currentWater - prevWater);
          
          // T√≠tulo secci√≥n Agua
          doc.setFontSize(11);
          doc.setTextColor(0, 0, 0);
          doc.setFont(undefined, 'bold');
          doc.text('AGUA', 14, yPos);
          yPos += 6;
          doc.setFont(undefined, 'normal');
          doc.text(`‚Ä¢ Consumo: ${actualWaterConsumption.toFixed(2)} m¬≥`, 20, yPos);
          yPos += 5;
          doc.text(`‚Ä¢ Lectura actual: ${currentWater.toFixed(2)} m¬≥`, 20, yPos);
          yPos += 5;
          if (prevWater > 0) {
            doc.text(`‚Ä¢ Lectura anterior: ${prevWater.toFixed(2)} m¬≥`, 20, yPos);
            yPos += 5;
          }
          yPos += 7;
          // Detalles de costos con mejor formato
          doc.setFont(undefined, 'bold');
          doc.text('Costos:', 20, yPos);
          yPos += 5;
          doc.setFont(undefined, 'normal');
          const totalFixedWater = waterFixedItems.reduce((sum, item) => sum + item.amount, 0);
          doc.text(`‚Ä¢ Fijos (50% de ${formatCurrency(totalFixedWater)}): ${formatCurrency(waterDistribution.fixedPerHouse)}`, 25, yPos);
          yPos += 7;
          const waterVariable = houseNumber === 1 ? 
            (waterDistribution.house1 - waterDistribution.fixedPerHouse) : 
            (waterDistribution.house2 - waterDistribution.fixedPerHouse);
          doc.text(`‚Ä¢ Variables: ${formatCurrency(waterVariable)}`, 25, yPos);
          yPos += 7;
          doc.setFont(undefined, 'bold');
          doc.text(`Subtotal Agua: ${formatCurrency(waterTotal)}`, 20, yPos);
          doc.setFont(undefined, 'normal');
          yPos += 12;

          // Electricity details
          const electricityTotal = houseNumber === 1 ? electricityDistribution.house1 : electricityDistribution.house2;
          const currentElectricity = houseNumber === 1 ? latestExpense.electricity1 : latestExpense.electricity2;
          const prevElectricity = houseNumber === 1 ? latestExpense.prevElectricity1 : latestExpense.prevElectricity2;
          const actualElectricityConsumption = Math.max(0, currentElectricity - prevElectricity);
          
          // T√≠tulo secci√≥n Electricidad
          yPos += 8;
          doc.setFont(undefined, 'bold');
          doc.text('ELECTRICIDAD', 14, yPos);
          yPos += 6;
          doc.setFont(undefined, 'normal');
          doc.text(`‚Ä¢ Consumo: ${actualElectricityConsumption.toFixed(2)} kWh`, 20, yPos);
          yPos += 5;
          doc.text(`‚Ä¢ Lectura actual: ${currentElectricity.toFixed(2)} kWh`, 20, yPos);
          yPos += 5;
          if (prevElectricity > 0) {
            doc.text(`‚Ä¢ Lectura anterior: ${prevElectricity.toFixed(2)} kWh`, 20, yPos);
            yPos += 5;
          }
          yPos += 7;
          // Detalles de costos con mejor formato
          doc.setFont(undefined, 'bold');
          doc.text('Costos:', 20, yPos);
          yPos += 5;
          doc.setFont(undefined, 'normal');
          const totalFixedElectricity = electricityFixedItems.reduce((sum, item) => sum + item.amount, 0);
          doc.text(`‚Ä¢ Fijos (50% de ${formatCurrency(totalFixedElectricity)}): ${formatCurrency(electricityDistribution.fixedPerHouse)}`, 25, yPos);
          yPos += 7;
          const electricityVariable = houseNumber === 1 ? 
            (electricityDistribution.house1 - electricityDistribution.fixedPerHouse) : 
            (electricityDistribution.house2 - electricityDistribution.fixedPerHouse);
          doc.text(`‚Ä¢ Variables: ${formatCurrency(electricityVariable)}`, 25, yPos);
          yPos += 7;
          doc.setFont(undefined, 'bold');
          doc.text(`Subtotal Electricidad: ${formatCurrency(electricityTotal)}`, 20, yPos);
          doc.setFont(undefined, 'normal');
          yPos += 12;

          // Secci√≥n de costos fijos
          yPos += 10;
          doc.setFontSize(10);
          doc.setFont(undefined, 'bold');
          doc.text('DETALLE DE COSTOS FIJOS', 14, yPos);
          yPos += 8;
          
          // L√≠nea divisoria m√°s delgada
          doc.setDrawColor(220, 220, 220);
          doc.line(14, yPos, 200, yPos);
          yPos += 7;
          const waterFixedItemsList = waterFixedItems.map(item => `  - Agua: ${item.name} (${formatCurrency(item.amount)})`).join('\n');
          const electricityFixedItemsList = electricityFixedItems.map(item => `  - Electricidad: ${item.name} (${formatCurrency(item.amount)})`).join('\n');
          doc.text(waterFixedItemsList, 14, yPos);
          yPos += (waterFixedItems.length * 7) + (waterFixedItems.length > 0 ? 5 : 0);
          doc.text(electricityFixedItemsList, 14, yPos);
          yPos += (electricityFixedItems.length * 7) + (electricityFixedItems.length > 0 ? 5 : 0);

          // Total con mejor formato
          yPos += 10;
          doc.setFontSize(14);
          doc.setFont(undefined, 'bold');
          doc.setTextColor(255, 255, 255);
          doc.setFillColor(59, 130, 246);
          doc.rect(14, yPos, 190, 12, 'F');
          doc.text(`TOTAL A PAGAR: ${formatCurrency(houseTotal)}`, 20, yPos + 8);
          yPos += 15;
          
          // Pie de p√°gina
          doc.setFontSize(8);
          doc.setTextColor(100);
          doc.setFont(undefined, 'italic');
          doc.text('Documento generado autom√°ticamente - ' + new Date().toLocaleString('es-CL'), 14, 290);
        };
        
        // Generar el reporte para la casa espec√≠fica
        generateReport(
          doc, 
          houseNumber,
          houseNumber === 1 ? latestExpense.house1Total : latestExpense.house2Total, 
          houseNumber === 1 ? latestExpense.water1 : latestExpense.water2, 
          houseNumber === 1 ? latestExpense.electricity1 : latestExpense.electricity2,
          latestExpense.waterDistribution, 
          latestExpense.electricityDistribution, 
          latestExpense.waterFixedItems || [], 
          latestExpense.electricityFixedItems || [], 
          true
        );
        
        // Guardar el PDF con un nombre descriptivo
        const fileName = `gastos_${tenantNames[houseNumber].toLowerCase().replace(/\s+/g, '_')}_${formattedDate.replace(/\s+/g, '_')}.pdf`;
        doc.save(fileName);
        
        return fileName;
    }

    // Funci√≥n principal para exportar PDFs
    async function exportToPDF() {
      const exportButton = document.getElementById('exportPdf');
      const originalButtonText = exportButton.innerHTML;

      try {
        exportButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generando PDFs...`;
        exportButton.disabled = true;

        const latestExpense = await db.expenses.orderBy('date').last();
        if (!latestExpense) {
          alert("No hay registros de gastos para exportar.");
          return;
        }

        // Generar PDF para cada casa
        const files = [];
        files.push(await generateHousePDF(1, latestExpense));
        files.push(await generateHousePDF(2, latestExpense));
        
        // Mostrar mensaje de √©xito con los archivos generados
        alert(`Se han generado los siguientes archivos:\n- ${files.join('\n- ')}`);
        
      } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Error al generar los PDFs: ' + error.message);
      } finally {
        exportButton.innerHTML = originalButtonText;
        exportButton.disabled = false;
      }
    }

    async function loadHistory() {
      if (isUpdating) {
        console.log('Update already in progress');
        return;
      }
      
      isUpdating = true;
      console.log('Loading history...');
      
      try {
        const expensesList = document.getElementById('expensesList');
        if (!expensesList) {
          console.error('Expenses list element not found in the DOM');
          isUpdating = false;
          return;
        }
        
        // Clear previous content and show loading state
        expensesList.innerHTML = `
          <tr>
            <td colspan="7" class="px-6 py-8 text-center">
              <div class="flex justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
              </div>
              <p class="mt-2 text-sm text-gray-500">Cargando historial...</p>
            </td>
          </tr>`;
        
        // Show loading state
        expensesList.innerHTML = `
          <tr>
            <td colspan="7" class="px-6 py-8 text-center">
              <div class="flex justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
              </div>
              <p class="mt-2 text-sm text-gray-500">Cargando historial...</p>
            </td>
          </tr>`;
        
        console.log('Fetching expenses from database...');
        let expenses = [];
        try {
          // Verificar que la tabla de gastos existe
          const tableNames = await db.tables.map(table => table.name);
          console.log('Tablas disponibles en la base de datos:', tableNames);
          
          if (!tableNames.includes('expenses')) {
            console.log('La tabla expenses no existe, se crear√° con el primer registro');
            expenses = [];
          } else {
            expenses = await db.expenses.orderBy('date').reverse().toArray();
            console.log(`Found ${expenses.length} expenses in database`, expenses);
          }
        } catch (dbError) {
          console.error('Error fetching expenses from database:', dbError);
          expensesList.innerHTML = `
            <tr>
              <td colspan="7" class="px-6 py-8 text-center text-red-600">
                Error al cargar el historial: ${dbError.message}
              </td>
            </tr>`;
          isUpdating = false;
          return;
        }
        
        if (!expenses || expenses.length === 0) {
          console.log('No se encontraron gastos en la base de datos');
          expensesList.innerHTML = `
            <tr>
              <td colspan="7" class="px-6 py-8 text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No hay registros</h3>
                <p class="mt-1 text-sm text-gray-500">Comienza agregando tu primer registro de gastos.</p>
              </td>
            </tr>`;
        } else {
          // Update summary cards
          updateSummaryCards(expenses);
          
          // Update total count
          document.getElementById('totalCount').textContent = expenses.length;
          
          // Show first 10 items
          const itemsPerPage = 10;
          const paginatedExpenses = expenses.slice(0, itemsPerPage);
          
          console.log('Rendering expenses table...');
          const rows = paginatedExpenses.map(expense => {
            try {
              const date = new Date(expense.date);
              const formattedDate = date.toLocaleDateString('es-CL', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
              });
              
              // Obtener lecturas actuales y anteriores
              const currentWater1 = expense.water1 || 0;
              const currentWater2 = expense.water2 || 0;
              const currentElectricity1 = expense.electricity1 || 0;
              const currentElectricity2 = expense.electricity2 || 0;
              
              // Calcular consumos reales (diferencia con lecturas anteriores)
              const prevWater1 = expense.prevWater1 || 0;
              const prevWater2 = expense.prevWater2 || 0;
              const prevElectricity1 = expense.prevElectricity1 || 0;
              const prevElectricity2 = expense.prevElectricity2 || 0;
              
              const water1 = Math.max(0, currentWater1 - prevWater1);
              const water2 = Math.max(0, currentWater2 - prevWater2);
              const electricity1 = Math.max(0, currentElectricity1 - prevElectricity1);
              const electricity2 = Math.max(0, currentElectricity2 - prevElectricity2);
              
              // Calcular totales por casa
              const total1 = (expense.house1Total || 0);
              const total2 = (expense.house2Total || 0);
              const total = total1 + total2;
              
              const isPaid = expense.status === 'paid';
              
              return `
                <tr class="hover:bg-gray-50 transition-colors">
                  <td class="px-4 py-3 text-sm text-gray-900 whitespace-nowrap">
                    <div class="font-medium">${formattedDate}</div>
                    <div class="text-xs text-gray-500">${date.toLocaleTimeString('es-CL', {hour: '2-digit', minute:'2-digit'})}</div>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-900">
                    <div class="font-medium">Servicios B√°sicos</div>
                    <div class="text-xs text-gray-500">Agua y Electricidad</div>
                  </td>
                  <td class="px-4 py-3 text-right">
                    <div class="font-medium">${formatCurrency(total1)}</div>
                    <div class="text-xs text-gray-500">
                      <div>Consumo: ${water1.toLocaleString('es-CL')} m¬≥</div>
                      <div class="text-gray-400 text-xs">
                        Lectura: ${currentWater1.toLocaleString('es-CL')} m¬≥
                        ${prevWater1 > 0 ? `(Anterior: ${prevWater1.toLocaleString('es-CL')} m¬≥)` : ''}
                      </div>
                      <div>${formatCurrency(expense.waterCost1 || 0)}</div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                      <div>Consumo: ${electricity1.toLocaleString('es-CL')} kWh</div>
                      <div class="text-gray-400 text-xs">
                        Lectura: ${currentElectricity1.toLocaleString('es-CL')} kWh
                        ${prevElectricity1 > 0 ? `(Anterior: ${prevElectricity1.toLocaleString('es-CL')} kWh)` : ''}
                      </div>
                      <div>${formatCurrency(expense.electricityCost1 || 0)}</div>
                    </div>
                  </td>
                  <td class="px-4 py-3 text-right">
                    <div class="font-medium">${formatCurrency(total2)}</div>
                    <div class="text-xs text-gray-500">
                      <div>Consumo: ${water2.toLocaleString('es-CL')} m¬≥</div>
                      <div class="text-gray-400 text-xs">
                        Lectura: ${currentWater2.toLocaleString('es-CL')} m¬≥
                        ${prevWater2 > 0 ? `(Anterior: ${prevWater2.toLocaleString('es-CL')} m¬≥)` : ''}
                      </div>
                      <div>${formatCurrency(expense.waterCost2 || 0)}</div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                      <div>Consumo: ${electricity2.toLocaleString('es-CL')} kWh</div>
                      <div class="text-gray-400 text-xs">
                        Lectura: ${currentElectricity2.toLocaleString('es-CL')} kWh
                        ${prevElectricity2 > 0 ? `(Anterior: ${prevElectricity2.toLocaleString('es-CL')} kWh)` : ''}
                      </div>
                      <div>${formatCurrency(expense.electricityCost2 || 0)}</div>
                    </div>
                  </td>
                  <td class="px-4 py-3 text-sm font-medium text-right">
                    ${formatCurrency(total)}
                  </td>
                  <td class="px-4 py-3">
                    <span class="status-badge ${isPaid ? 'status-paid' : 'status-pending'}">
                      ${isPaid ? 'Pagado' : 'Pendiente'}
                    </span>
                  </td>
                  <td class="px-4 py-3 text-sm font-medium text-right whitespace-nowrap">
                    <button class="text-blue-600 hover:text-blue-900 mr-3">Ver</button>
                    <button class="text-gray-600 hover:text-gray-900">
                      <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
                      </svg>
                    </button>
                  </td>
                </tr>`;
            } catch (error) {
              console.error('Error processing expense:', expense, error);
              return ''; // Skip this row if there's an error
            }
          }).join('');
          
          if (rows.length > 0) {
            expensesList.innerHTML = rows;
            
            // Add event listeners for view buttons
            document.querySelectorAll('.view-expense').forEach(button => {
              button.addEventListener('click', () => {
                // Handle view button click
              });
            });
            
            // Update showing count
            const showingCount = document.getElementById('showingCount');
            if (showingCount) {
              showingCount.textContent = `1-${Math.min(paginatedExpenses.length, expenses.length)}`;
            }
          } else {
            expensesList.innerHTML = `
              <tr>
                <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                  No hay datos para mostrar.
                </td>
              </tr>`;
          }
        }
      } catch (error) {
        console.error('Error in loadHistory:', error);
        console.error('Error loading history:', error);
        const expensesList = document.getElementById('expensesList');
        if (expensesList) {
          expensesList.innerHTML = `
            <tr>
              <td colspan="7" class="px-6 py-8 text-center">
                <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Error al cargar el historial</h3>
                <p class="mt-1 text-sm text-red-600">${error.message || 'Intenta recargar la p√°gina'}</p>
                <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                  Recargar P√°gina
                </button>
              </td>
            </tr>`;
        }
      } finally {
        isUpdating = false;
      }
    }

    async function loadLastReadings() {
      try {
        const readings = await db.lastReadings.get(1);
        if (readings) {
          document.getElementById('prevWater1').value = readings.water1 || 0;
          document.getElementById('prevWater2').value = readings.water2 || 0;
          document.getElementById('prevElectricity1').value = readings.electricity1 || 0;
          document.getElementById('prevElectricity2').value = readings.electricity2 || 0;
        }
      } catch (error) {
        console.error('Error loading last readings:', error);
      }
    }
    
    // Distributes costs based on consumption and fixed items
    function distributeCosts(consumption1, consumption2, totalBill, fixedItems = []) {
      const totalConsumption = consumption1 + consumption2;
      
      const fixedItemsTotal = fixedItems.reduce((sum, item) => sum + item.amount, 0);
      const proportionalAmount = Math.max(0, totalBill - fixedItemsTotal);
      
      const fixedPerHouse = fixedItemsTotal / 2;
      
      let proportional1 = 0;
      let proportional2 = 0;
      
      if (totalConsumption > 0) {
        proportional1 = (consumption1 / totalConsumption) * proportionalAmount;
        proportional2 = (consumption2 / totalConsumption) * proportionalAmount;
      } else if (proportionalAmount > 0) {
        proportional1 = proportionalAmount / 2;
        proportional2 = proportionalAmount / 2;
      }

      const house1Total = fixedPerHouse + proportional1;
      const house2Total = fixedPerHouse + proportional2;
      
      return {
        house1: house1Total,
        house2: house2Total,
        fixedPerHouse: fixedPerHouse,
        proportional: proportionalAmount
      };
    }
    
    document.getElementById('saveButton').addEventListener('click', async () => {
      const prevWater1 = parseFloat(document.getElementById('prevWater1').value) || 0;
      const prevWater2 = parseFloat(document.getElementById('prevWater2').value) || 0;
      const prevElectricity1 = parseFloat(document.getElementById('prevElectricity1').value) || 0;
      const prevElectricity2 = parseFloat(document.getElementById('prevElectricity2').value) || 0;
      
      const water1 = parseFloat(document.getElementById('water1').value) || 0;
      const water2 = parseFloat(document.getElementById('water2').value) || 0;
      const electricity1 = parseFloat(document.getElementById('electricity1').value) || 0;
      const electricity2 = parseFloat(document.getElementById('electricity2').value) || 0;
      
      if (water1 < prevWater1 || water2 < prevWater2) {
        alert('Las lecturas actuales de agua no pueden ser menores a las lecturas anteriores.');
        return;
      }
      if (electricity1 < prevElectricity1 || electricity2 < prevElectricity2) {
        alert('Las lecturas actuales de electricidad no pueden ser menores a las lecturas anteriores.');
        return;
      }
      
      const waterConsumption1 = Math.max(0, water1 - prevWater1);
      const waterConsumption2 = Math.max(0, water2 - prevWater2);
      const electricityConsumption1 = Math.max(0, electricity1 - prevElectricity1);
      const electricityConsumption2 = Math.max(0, electricity2 - prevElectricity2);
      
      const totalWaterBill = parseFloat(document.getElementById('totalWaterBill').value) || 0;
      const totalElectricityBill = parseFloat(document.getElementById('totalElectricityBill').value) || 0;
      
      const fixedCosts = await getOrCreateMonthlyFixedCosts();
      const fixedWaterTotal = fixedCosts.waterItems.reduce((sum, item) => sum + item.amount, 0) || 0;
      const fixedElectricityTotal = fixedCosts.electricityItems.reduce((sum, item) => sum + item.amount, 0) || 0;

      if (totalWaterBill > 0 && totalWaterBill < fixedWaterTotal) {
        alert('La factura total de agua debe ser mayor o igual a los costos fijos de agua.');
        return;
      }
      if (totalElectricityBill > 0 && totalElectricityBill < fixedElectricityTotal) {
        alert('La factura total de electricidad debe ser mayor o igual a los costos fijos de electricidad.');
        return;
      }

      const waterDistribution = distributeCosts(
        waterConsumption1, waterConsumption2, totalWaterBill, fixedCosts.waterItems
      );
      const electricityDistribution = distributeCosts(
        electricityConsumption1, electricityConsumption2, totalElectricityBill, fixedCosts.electricityItems
      );
      
      const expense = {
        date: new Date(),
        prevWater1, water1, waterConsumption1, prevWater2, water2, waterConsumption2, totalWaterBill, waterFixedItems: fixedCosts.waterItems,
        prevElectricity1, electricity1, electricityConsumption1, prevElectricity2, electricity2, electricityConsumption2, totalElectricityBill, electricityFixedItems: fixedCosts.electricityItems,
        waterDistribution: { house1: waterDistribution.house1, house2: waterDistribution.house2, fixedPerHouse: waterDistribution.fixedPerHouse, proportional: totalWaterBill - fixedWaterTotal },
        electricityDistribution: { house1: electricityDistribution.house1, house2: electricityDistribution.house2, fixedPerHouse: electricityDistribution.fixedPerHouse, proportional: totalElectricityBill - fixedElectricityTotal },
        house1Total: waterDistribution.house1 + electricityDistribution.house1,
        house2Total: waterDistribution.house2 + electricityDistribution.house2
      };

      await db.expenses.add(expense);
      await db.lastReadings.put({
        id: 1,
        water1,
        water2,
        electricity1,
        electricity2
      });

      document.getElementById('water1').value = '';
      document.getElementById('water2').value = '';
      document.getElementById('totalWaterBill').value = '';
      document.getElementById('electricity1').value = '';
      document.getElementById('electricity2').value = '';
      document.getElementById('totalElectricityBill').value = '';

      await Promise.all([
        loadLastReadings(),
        loadHistory()
      ]);
    });

    document.getElementById('exportPdf').addEventListener('click', exportToPDF);

    // Safe initialization function
    async function initializeApp() {
      try {
        console.log('Initializing application...');
        const dbInitialized = await initDatabase();
        if (!dbInitialized) {
          console.error('Failed to initialize database');
          return;
        }
        
        // Setup event listeners for add buttons
        const addWaterButton = document.getElementById('addWaterItemButton');
        const addElectricityButton = document.getElementById('addElectricityItemButton');
        
        if (addWaterButton) {
          addWaterButton.addEventListener('click', () => addFixedCostItem('water'));
        }
        
        if (addElectricityButton) {
          addElectricityButton.addEventListener('click', () => addFixedCostItem('electricity'));
        }
        
        // Setup input field listeners
        setupInputListeners('water');
        setupInputListeners('electricity');
        
        // Cargar costos fijos si el elemento existe
        const fixedCostsSection = document.querySelector('section:first-of-type');
        if (fixedCostsSection) {
          await loadFixedCosts();
          await loadLastReadings();
          
          // Mostrar el mes actual
          const currentMonth = new Date().toLocaleString('es-CL', { month: 'long', year: 'numeric' });
          const monthDisplay = document.getElementById('currentMonthDisplay');
          if (monthDisplay) {
            monthDisplay.textContent = `Costos Fijos - ${currentMonth.charAt(0).toUpperCase() + currentMonth.slice(1)}`;
          }
        }
        
        // Cargar historial si el elemento existe
        const expensesList = document.getElementById('expensesList');
        if (expensesList) {
          console.log('Cargando historial...');
          await loadHistory();
          
          // Configurar bot√≥n de exportar PDF si existe
          const exportButton = document.getElementById('exportPdf');
          if (exportButton) {
            exportButton.addEventListener('click', exportToPDF);
          }
        } else {
          console.log('No se encontr√≥ el elemento expensesList');
        }
        
        console.log('Application initialized successfully');
      } catch (error) {
        console.error('Error during initialization:', error);
      } finally {
        isUpdating = false;
      }
    }
    
    // Start the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeApp);

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(error => {
            console.error('ServiceWorker registration failed: ', error);
          });
      });
    }

    // PWA Installation
    let deferredPrompt;
    const installButton = document.getElementById('installButton');
    
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent Chrome 67 and earlier from automatically showing the prompt
      e.preventDefault();
      // Stash the event so it can be triggered later
      deferredPrompt = e;
      // Show the install button
      installButton.classList.remove('hidden');
      
      installButton.addEventListener('click', () => {
        // Hide the install button
        installButton.classList.add('hidden');
        // Show the install prompt
        deferredPrompt.prompt();
        // Wait for the user to respond to the prompt
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('User accepted the install prompt');
          } else {
            console.log('User dismissed the install prompt');
          }
          deferredPrompt = null;
        });
      });
    });

    // Track successful installation
    window.addEventListener('appinstalled', (evt) => {
      console.log('App was installed.');
      installButton.classList.add('hidden');
    });
  </script>
</body>
</html>