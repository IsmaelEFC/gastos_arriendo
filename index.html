<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3498db">
    <title>El Campeón - Punto de Venta</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#3498db">
    <meta name="description" content="Sistema de punto de venta para El Campeón">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="El Campeón">
    <meta name="application-name" content="El Campeón">
</head>
<body>
    <header>
        <h1>Control de Caja</h1>
        <p>Hoy: <span id="fecha-actual"></span></p>
    </header>

    <main>
        <section id="productos-section" class="card">
            <h2>Seleccionar Producto</h2>
            <div id="categorias-container">
                </div>
            <button id="agregar-producto-btn" class="btn btn-secondary">Agregar Nuevo Producto</button>
        </section>

        <section id="resumen-section" class="card">
            <h2>Resumen del Día</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <span>Efectivo:</span>
                    <span id="total-efectivo" class="valor">$0</span>
                </div>
                <div class="stat-item">
                    <span>Transferencia:</span>
                    <span id="total-transferencia" class="valor">$0</span>
                </div>
            </div>
            <div class="button-group">
                <button id="ver-total-detalle" class="btn btn-primary">Ver Total y Detalle</button>
                <button id="reiniciar-dia" class="btn btn-danger">Cerrar y Reiniciar Caja</button>
            </div>
            <p class="note">Al reiniciar, los totales se guardan en el historial y se borran para el día siguiente.</p>
        </section>
    </main>

    <div class="modal" id="modal-pago">
        <div class="modal-content">
            <span class="close-button" data-modal="modal-pago">&times;</span>
            <h3>Total a Pagar: <span id="monto-modal" class="valor-modal">$0</span></h3>
            <p>Seleccione el método de pago:</p>
            <div class="modal-buttons">
                <button id="pago-efectivo" class="btn btn-primary">Pago en Efectivo</button>
                <button id="pago-transferencia" class="btn btn-secondary">Pago por Transferencia</button>
                <button id="pago-combinado" class="btn btn-tertiary">Pago Combinado</button>
                <button id="cancelar-pago" class="btn btn-danger">Cancelar</button>
            </div>
            <div id="pago-combinado-form" style="display: none; margin-top: 15px;">
                <div class="form-group">
                    <label for="monto-efectivo">Monto en Efectivo:</label>
                    <input type="number" id="monto-efectivo" class="form-control" min="0" step="100">
                </div>
                <div class="form-group">
                    <label for="monto-transferencia">Monto por Transferencia:</label>
                    <input type="number" id="monto-transferencia" class="form-control" min="0" step="100">
                </div>
                <div class="form-group">
                    <button id="confirmar-combinado" class="btn btn-primary">Confirmar Pago</button>
                    <button id="cancelar-combinado" class="btn btn-secondary">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-detalle">
        <div class="modal-content" id="reporte-pdf-content">
            <span class="close-button" data-modal="modal-detalle">&times;</span>
            <h3>Resumen de Ventas</h3>
            <div class="stats-grid-modal">
                <div class="stat-item">
                    <span>Total Generado:</span>
                    <span id="total-generado" class="valor-modal">$0</span>
                </div>
            </div>
            <h4>Detalle por Producto</h4>
            <ul id="detalle-lista">
                </ul>
            <p class="note">Mostrando ventas actuales del día.</p>
        </div>
        <div class="modal-footer">
            <button id="generar-pdf-btn" class="btn btn-primary">Descargar Reporte y Reiniciar</button>
        </div>
    </div>

    <div class="modal" id="modal-agregar-producto">
        <div class="modal-content">
            <span class="close-button" data-modal="modal-agregar-producto">&times;</span>
            <h3>Nuevo Producto</h3>
            <form id="form-nuevo-producto">
                <div class="form-group">
                    <label for="nombre-producto">Nombre:</label>
                    <input type="text" id="nombre-producto" required>
                </div>
                <div class="form-group">
                    <label for="precio-producto">Precio:</label>
                    <input type="number" id="precio-producto" min="0" required>
                </div>
                <div class="form-group">
                    <label for="categoria-producto">Categoría:</label>
                    <select id="categoria-producto" required></select>
                </div>
                <button type="submit" class="btn btn-primary">Guardar Producto</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                if ('caches' in window) {
                    caches.keys().then(cacheNames => {
                        cacheNames.forEach(cacheName => {
                            if (cacheName.startsWith('el-campeon-')) {
                                caches.delete(cacheName);
                            }
                        });
                    });
                }

                navigator.serviceWorker.register('./sw.js', { scope: './' })
                    .then(registration => {
                        console.log('ServiceWorker registrado con éxito:', registration.scope);
                        
                        if (registration.waiting) {
                            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                        }
                        
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('Nueva versión disponible. Actualizando...');
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                }
                            });
                        });
                        
                        setInterval(() => {
                            registration.update().catch(console.error);
                        }, 60 * 60 * 1000);
                    })
                    .catch(error => {
                        console.error('Error al registrar el ServiceWorker:', error);
                    });

                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('Nuevo Service Worker tomando el control');
                    window.location.reload();
                });
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', registerServiceWorker);
        } else {
            registerServiceWorker();
        }

        if (window.location.search.includes('update=1')) {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    for (let registration of registrations) {
                        registration.unregister();
                    }
                    console.log('Service Workers desregistrados. Recargando...');
                    window.location.href = window.location.pathname;
                });
            }
        }
    </script>
    <script src="app.js"></script>
</body>
</html>